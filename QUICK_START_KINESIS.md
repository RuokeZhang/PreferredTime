# Kinesis-Lambda æ¨èç³»ç»Ÿå¿«é€Ÿå¼€å§‹

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å¿«é€Ÿå¯åŠ¨å’Œæµ‹è¯•Kinesis-Lambdaäº‹ä»¶é©±åŠ¨çš„æ¨èç³»ç»Ÿã€‚

## ğŸš€ å¿«é€Ÿå¯åŠ¨ï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰

### å‰ç½®è¦æ±‚

- Python 3.11+
- Docker (å¯é€‰ï¼Œç”¨äºRedis)
- å·²æœ‰è¯„åˆ†æ•°æ®

### æ­¥éª¤ 1: å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

æ–°å¢çš„ä¾èµ–:
- `redis==5.0.1` - Rediså®¢æˆ·ç«¯
- `requests==2.31.0` - HTTPå®¢æˆ·ç«¯

### æ­¥éª¤ 2: å¯åŠ¨FastAPIæœåŠ¡

```bash
# ä¸å¯ç”¨Redisï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰
export REDIS_ENABLED=false

# å¯åŠ¨æœåŠ¡
uvicorn api.main:app --host 0.0.0.0 --port 8082 --reload
```

æœåŠ¡å¯åŠ¨åè®¿é—®: http://localhost:8082

### æ­¥éª¤ 3: æµ‹è¯•æ–°ç«¯ç‚¹

#### æµ‹è¯•å†…éƒ¨æ¨èç«¯ç‚¹ï¼ˆLambdaä¸“ç”¨ï¼‰
```bash
curl "http://localhost:8082/internal/recommend/1?top_n=10"
```

é¢„æœŸå“åº”:
```json
{
  "user_id": 1,
  "recommendations": [123, 456, 789, ...],
  "count": 10
}
```

#### æµ‹è¯•å¥åº·æ£€æŸ¥
```bash
curl http://localhost:8082/health
```

é¢„æœŸå“åº”:
```json
{
  "status": "healthy",
  "storage_mode": "sqlite",
  "recommender_loaded": true,
  "redis_enabled": false,
  "redis_connected": false
}
```

### æ­¥éª¤ 4: æµ‹è¯•Lambdaå‡½æ•°

```bash
# è¿è¡ŒKinesis-Lambdaé›†æˆæµ‹è¯•
python test_kinesis_lambda.py
```

æµ‹è¯•è„šæœ¬ä¼š:
1. âœ… æ¨¡æ‹ŸKinesisäº‹ä»¶
2. âœ… è°ƒç”¨Lambdaå¤„ç†å™¨
3. âœ… æµ‹è¯•å•ç”¨æˆ·æ¨è
4. âœ… æµ‹è¯•æ‰¹é‡æ¨èï¼ˆ10ä¸ªç”¨æˆ·ï¼‰
5. âœ… æµ‹è¯•é”™è¯¯å¤„ç†

é¢„æœŸè¾“å‡º:
```
ğŸš€ Kinesis-Lambdaæ¨èæµç¨‹æµ‹è¯•
============================================================
é…ç½®:
  FastAPI Endpoint: http://localhost:8082
  Redis Enabled: false
============================================================

============================================================
æµ‹è¯• 1: å•ä¸ªç”¨æˆ·æ¨è
============================================================
[test-001] å¤„ç†æ¨èè¯·æ±‚ - user_id: 1, top_n: 10
[test-001] ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨æ¨èæœåŠ¡...
[test-001] âœ“ å»¶è¿Ÿ: 45ms (P99ç›®æ ‡: <100ms) âœ…

âœ“ Lambdaå“åº”:
  å¤„ç†æˆåŠŸ: 1
  å¹³å‡å»¶è¿Ÿ: 45ms
  ç¼“å­˜å‘½ä¸­ç‡: 0.0%

============================================================
æµ‹è¯• 2: æ‰¹é‡ç”¨æˆ·æ¨è
============================================================
âœ“ æ‰¹å¤„ç†ç»“æœ:
  æ€»å¤„ç†æ—¶é—´: 350ms
  å¤„ç†æˆåŠŸ: 10
  å¹³å‡å»¶è¿Ÿ: 42ms
  ååé‡: 28.6 è¯·æ±‚/ç§’

æ€§èƒ½æŒ‡æ ‡:
  P99 latency: 58ms âœ…
  P99ç›®æ ‡: <100ms

============================================================
âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼
============================================================
ğŸ¯ æ¶æ„å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥éƒ¨ç½²åˆ°AWS!
```

---

## ğŸ”¥ å¸¦Redisç¼“å­˜æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

å¦‚æœæƒ³æµ‹è¯•å®Œæ•´çš„ç¼“å­˜åŠŸèƒ½:

### 1. å¯åŠ¨Redis

```bash
# ä½¿ç”¨Dockerå¯åŠ¨Redis
docker run -d --name redis -p 6379:6379 redis:7.0

# æˆ–ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨
# brew install redis && brew services start redis
```

### 2. å¯ç”¨Rediså¹¶é‡å¯æœåŠ¡

```bash
export REDIS_ENABLED=true
export REDIS_ENDPOINT=localhost
export REDIS_PORT=6379

# é‡å¯FastAPI
uvicorn api.main:app --host 0.0.0.0 --port 8082 --reload
```

### 3. æµ‹è¯•ç¼“å­˜æ€§èƒ½

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡å¹¶è¿è¡Œæµ‹è¯•
REDIS_ENABLED=true REDIS_ENDPOINT=localhost python test_kinesis_lambda.py
```

ä½ ä¼šçœ‹åˆ°:
- **ç¬¬ä¸€æ¬¡è¯·æ±‚**: ç¼“å­˜æœªå‘½ä¸­ï¼Œå»¶è¿Ÿ 50-100ms
- **ç¬¬äºŒæ¬¡è¯·æ±‚**: ç¼“å­˜å‘½ä¸­ï¼Œå»¶è¿Ÿ 5-20ms
- **æ€§èƒ½æå‡**: 80-90%

---

## ğŸ“¦ Dockeréƒ¨ç½²æµ‹è¯•

### æ„å»ºDockeré•œåƒ

```bash
# FastAPIæœåŠ¡é•œåƒ
docker build -t movie-rec-api .

# Lambdaå‡½æ•°é•œåƒ
cd lambda
docker build -t movie-rec-lambda .
```

### è¿è¡Œå®¹å™¨

```bash
# è¿è¡ŒFastAPIå®¹å™¨
docker run -d \
  --name movie-rec-api \
  -p 8082:8082 \
  -e REDIS_ENABLED=false \
  movie-rec-api

# æµ‹è¯•
curl http://localhost:8082/health
```

---

## ğŸ¯ æ€§èƒ½åŸºå‡†

### æœ¬åœ°æµ‹è¯•ï¼ˆæ— Redisï¼‰

| æŒ‡æ ‡ | å€¼ |
|-----|-----|
| å•æ¬¡æ¨èå»¶è¿Ÿ | 40-80ms |
| æ‰¹é‡å¤„ç†ï¼ˆ10ç”¨æˆ·ï¼‰ | 350-500ms |
| ååé‡ | 20-30 è¯·æ±‚/ç§’ |

### å¸¦Redisç¼“å­˜

| æŒ‡æ ‡ | ç¼“å­˜å‘½ä¸­ | ç¼“å­˜æœªå‘½ä¸­ |
|-----|---------|-----------|
| å»¶è¿Ÿ | 5-20ms âœ… | 50-100ms |
| P99å»¶è¿Ÿ | <25ms âœ… | <100ms âœ… |
| ååé‡ | 200+ req/s | 20-30 req/s |
| ç¼“å­˜å‘½ä¸­ç‡ | ç›®æ ‡ >70% | - |

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: FastAPIæœåŠ¡å¯åŠ¨å¤±è´¥

**æ£€æŸ¥**:
```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
lsof -i :8082

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/api.log
```

### é—®é¢˜ 2: Lambdaæµ‹è¯•å¤±è´¥

**å¸¸è§åŸå› **:
- FastAPIæœåŠ¡æœªå¯åŠ¨
- æ²¡æœ‰è¯„åˆ†æ•°æ®

**è§£å†³**:
```bash
# ç¡®ä¿æœåŠ¡è¿è¡Œ
curl http://localhost:8082/health

# å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå…ˆå‘é€ä¸€äº›æµ‹è¯•æ•°æ®
python test_producer.py
```

### é—®é¢˜ 3: Redisè¿æ¥å¤±è´¥

**æ£€æŸ¥**:
```bash
# æµ‹è¯•Redisè¿æ¥
redis-cli ping
# åº”è¯¥è¿”å›: PONG

# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
docker ps | grep redis
```

---

## ğŸ“š ä¸‹ä¸€æ­¥

### æœ¬åœ°å¼€å‘å®Œæˆå:

1. **æ„å»ºå¹¶æ¨é€é•œåƒåˆ°ECR**
   ```bash
   aws ecr get-login-password | docker login ...
   docker push <ecr-url>/movie-rec-api:latest
   docker push <ecr-url>/movie-rec-lambda:latest
   ```

2. **éƒ¨ç½²åˆ°AWS**
   - åˆ›å»ºKinesis Stream
   - éƒ¨ç½²Lambdaå‡½æ•°
   - å¯åŠ¨ECSæœåŠ¡
   - é…ç½®ElastiCache

3. **é…ç½®ç›‘æ§**
   - CloudWatchæ—¥å¿—
   - æ€§èƒ½æŒ‡æ ‡
   - å‘Šè­¦è§„åˆ™

è¯¦è§: [KINESIS_LAMBDA_ARCHITECTURE.md](KINESIS_LAMBDA_ARCHITECTURE.md)

---

## âœ… éªŒè¯æ¸…å•

éƒ¨ç½²å‰ç¡®è®¤:

- [ ] FastAPIæœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] `/internal/recommend` ç«¯ç‚¹å·¥ä½œæ­£å¸¸
- [ ] `/health` è¿”å›å¥åº·çŠ¶æ€
- [ ] Lambdaå‡½æ•°æœ¬åœ°æµ‹è¯•é€šè¿‡
- [ ] æ‰¹é‡å¤„ç†æ­£å¸¸ï¼ˆ10+ ç”¨æˆ·ï¼‰
- [ ] P99å»¶è¿Ÿ <100ms (æ— ç¼“å­˜æ—¶å¯èƒ½ç¨é«˜)
- [ ] é”™è¯¯å¤„ç†æ­£å¸¸
- [ ] Dockeré•œåƒæ„å»ºæˆåŠŸ

**å…¨éƒ¨é€šè¿‡** â†’ ğŸš€ å‡†å¤‡éƒ¨ç½²åˆ°AWS!

---

## ğŸ’¡ æç¤º

1. **æœ¬åœ°å¼€å‘**: ä¸éœ€è¦Redisï¼Œç›´æ¥æµ‹è¯•æ¨èé€»è¾‘
2. **æ€§èƒ½æµ‹è¯•**: å¯ç”¨Redisçœ‹ç¼“å­˜æ•ˆæœ
3. **å‹åŠ›æµ‹è¯•**: ä½¿ç”¨ `test_kinesis_lambda.py` æ‰¹é‡æµ‹è¯•
4. **ç›‘æ§å»¶è¿Ÿ**: è§‚å¯Ÿæ—¥å¿—ä¸­çš„ `latency_ms` æŒ‡æ ‡

æœ‰é—®é¢˜ï¼ŸæŸ¥çœ‹ [KINESIS_LAMBDA_ARCHITECTURE.md](KINESIS_LAMBDA_ARCHITECTURE.md) äº†è§£è¯¦ç»†æ¶æ„ã€‚


