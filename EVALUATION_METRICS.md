# 推荐系统评估指标说明

本文档详细说明电影推荐系统中使用的评估指标及其含义。

## 📊 评估流程

### 1. 训练集/测试集划分
- **划分比例**: 80% 训练集，20% 测试集
- **划分策略**: 对每个用户的评分数据进行随机划分（至少5条评分的用户）
- **目的**: 模拟真实场景，用已知数据预测未知偏好

### 2. 评估方法
- 使用训练集重建模型
- 为测试用户生成推荐列表
- 将推荐结果与测试集中的真实偏好对比
- 计算各项评估指标

---

## 🎯 准确率指标 (Accuracy Metrics)

### Precision@K (精确率)
**定义**: 推荐列表前K个结果中，相关（用户喜欢）的物品所占的比例

**公式**: 
```
Precision@K = (推荐列表前K个中相关的物品数) / K
```

**示例**: 
- 推荐Top-10电影: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
- 用户实际喜欢: [2, 5, 11, 15]
- 命中: [2, 5]，共2部
- Precision@10 = 2/10 = 0.20 (20%)

**意义**: 
- ✅ 衡量推荐的准确性
- ✅ 值越高越好（0-1之间）
- ⚠️ 不考虑遗漏了多少相关物品

---

### Recall@K (召回率)
**定义**: 推荐列表前K个结果覆盖了多少用户真正喜欢的物品

**公式**: 
```
Recall@K = (推荐列表前K个中相关的物品数) / (所有相关物品数)
```

**示例**: 
- 推荐Top-10电影: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
- 用户实际喜欢: [2, 5, 11, 15]（共4部）
- 命中: [2, 5]，共2部
- Recall@10 = 2/4 = 0.50 (50%)

**意义**: 
- ✅ 衡量推荐的完整性
- ✅ 值越高越好（0-1之间）
- ⚠️ 不考虑推荐列表中不相关物品的数量

---

### F1-Score@K (F1分数)
**定义**: Precision和Recall的调和平均数，综合考虑准确率和召回率

**公式**: 
```
F1@K = 2 × (Precision@K × Recall@K) / (Precision@K + Recall@K)
```

**示例**: 
- Precision@10 = 0.20
- Recall@10 = 0.50
- F1@10 = 2 × (0.20 × 0.50) / (0.20 + 0.50) = 0.286

**意义**: 
- ✅ 平衡Precision和Recall
- ✅ 当两者都重要时使用
- ✅ 值越高越好（0-1之间）

---

## 📈 排序质量指标 (Ranking Metrics)

### NDCG@K (归一化折损累积增益)
**定义**: 考虑推荐结果排序位置的评估指标，排在前面的相关物品权重更高

**计算过程**:
1. **DCG (Discounted Cumulative Gain)**: 
   ```
   DCG@K = Σ(i=1 to K) rel_i / log2(i+1)
   ```
   其中 rel_i 表示位置i的相关性（相关=1，不相关=0）

2. **IDCG (Ideal DCG)**: 理想情况下（所有相关物品都排在前面）的DCG

3. **NDCG**: 
   ```
   NDCG@K = DCG@K / IDCG@K
   ```

**示例**: 
- 推荐Top-5: [1, 2, 3, 4, 5]
- 相关性: [1, 0, 1, 0, 0]（第1和第3个相关）
- DCG = 1/log2(2) + 1/log2(4) = 1.0 + 0.5 = 1.5
- IDCG = 1/log2(2) + 1/log2(3) = 1.0 + 0.63 = 1.63
- NDCG@5 = 1.5 / 1.63 = 0.92

**意义**: 
- ✅ 考虑推荐顺序，越靠前权重越高
- ✅ 更符合实际使用场景（用户更关注前面的推荐）
- ✅ 值越高越好（0-1之间）
- 📌 工业界最常用的排序指标之一

---

### Hit Rate@K (命中率)
**定义**: 推荐列表前K个结果中，是否至少命中一个用户喜欢的物品

**公式**: 
```
Hit Rate@K = (命中用户数) / (总用户数)
其中，只要推荐列表中有至少1个相关物品，该用户就算命中
```

**示例**: 
- 用户A推荐: [1, 2, 3, 4, 5]，实际喜欢: [2, 6] → 命中✓
- 用户B推荐: [1, 2, 3, 4, 5]，实际喜欢: [6, 7] → 未命中✗
- 用户C推荐: [1, 2, 3, 4, 5]，实际喜欢: [1, 2, 3] → 命中✓
- Hit Rate@5 = 2/3 = 0.67

**意义**: 
- ✅ 衡量推荐系统的基本有效性
- ✅ 简单直观，易于理解
- ✅ 值越高越好（0-1之间）
- ⚠️ 不区分命中1个还是多个相关物品

---

## 🎨 多样性和覆盖率指标 (Diversity & Coverage)

### Coverage (覆盖率)
**定义**: 推荐系统能够推荐的不同物品数量占物品总数的比例

**公式**: 
```
Coverage = (被推荐过的不同电影数) / (电影总数)
```

**示例**: 
- 电影总数: 1000部
- 为所有用户推荐后，涉及了350部不同的电影
- Coverage = 350/1000 = 0.35 (35%)

**意义**: 
- ✅ 衡量推荐的多样性
- ✅ 避免只推荐热门物品（长尾问题）
- ⚠️ 过高可能导致推荐不准确的物品
- 📌 平衡准确性和多样性很重要

---

### Diversity (多样性)
**定义**: 不同用户的推荐列表之间的差异程度

**计算方法**: 
1. 计算所有推荐列表对之间的Jaccard距离
2. Jaccard距离 = 1 - Jaccard相似度
3. Jaccard相似度 = |A ∩ B| / |A ∪ B|

**示例**: 
- 用户A推荐: [1, 2, 3, 4, 5]
- 用户B推荐: [3, 4, 5, 6, 7]
- 交集: {3, 4, 5}，并集: {1, 2, 3, 4, 5, 6, 7}
- Jaccard相似度 = 3/7 = 0.43
- Jaccard距离 = 1 - 0.43 = 0.57

对所有用户对计算平均值得到整体多样性。

**意义**: 
- ✅ 衡量推荐的个性化程度
- ✅ 值越高说明推荐越个性化（0-1之间）
- ⚠️ 过高可能说明推荐太随机
- 📌 优秀的推荐系统应该平衡准确性和个性化

---

## 🎚️ 评估参数设置

### K值选择
当前系统评估三个K值：
- **K=5**: 用户很可能看到的前5个推荐
- **K=10**: 常见的推荐列表大小
- **K=20**: 更长的推荐列表

### 相关性阈值
- **评分阈值**: 3.5分
- 评分 ≥ 3.5 的电影被认为是用户喜欢的（相关）
- 评分 < 3.5 的电影被认为是用户不喜欢的（不相关）

---

## 🚀 模型部署质量阈值

模型必须满足以下条件才能部署到生产环境：

| 指标 | 最低要求 | 说明 |
|------|---------|------|
| Precision@10 | ≥ 0.01 | 至少1%的精确率 |
| Hit Rate@10 | ≥ 0.10 | 至少10%的命中率 |
| Coverage | ≥ 0.05 | 至少覆盖5%的电影 |
| Evaluated Users | ≥ 10 | 至少评估10个用户 |

**部署逻辑**:
- ✅ 所有条件都满足 → 部署新模型
- ❌ 任何条件不满足 → 保留旧模型，跳过部署

---

## 📝 指标解读建议

### 优秀模型的典型表现
```
Precision@10:  0.10 - 0.30  (10%-30%)
Recall@10:     0.20 - 0.50  (20%-50%)
F1@10:         0.15 - 0.35
NDCG@10:       0.30 - 0.60
Hit Rate@10:   0.60 - 0.90  (60%-90%)
Coverage:      0.20 - 0.50  (20%-50%)
Diversity:     0.60 - 0.90  (60%-90%)
```

### 指标权衡
1. **准确性 vs 多样性**: 
   - 高准确性可能导致低多样性（只推荐安全选项）
   - 需要在两者之间找到平衡

2. **Precision vs Recall**: 
   - 推荐更多物品可以提高Recall，但会降低Precision
   - 选择合适的K值很重要

3. **短期满意度 vs 长期探索**: 
   - 只推荐已知喜好很安全，但用户会觉得无趣
   - 适度推荐新物品有助于探索用户新兴趣

---

## 🔧 如何改进指标

### 提高Precision/Recall
- ✅ 收集更多用户行为数据
- ✅ 优化特征工程
- ✅ 调整模型权重（CF vs Content-based）
- ✅ 过滤低质量推荐

### 提高NDCG
- ✅ 优化推荐排序算法
- ✅ 考虑用户偏好强度
- ✅ 使用学习排序(Learning to Rank)方法

### 提高Coverage/Diversity
- ✅ 降低热门物品的权重
- ✅ 引入探索策略（Exploration）
- ✅ 使用多样性重排序算法

---

## 📚 参考资源

- **Precision/Recall**: 经典信息检索指标
- **NDCG**: 搜索引擎评估标准指标
- **Hit Rate**: 推荐系统基础指标
- **Coverage/Diversity**: 推荐系统质量指标

**推荐阅读**:
- Ricci, F., et al. (2015). "Recommender Systems Handbook"
- Herlocker, J. L., et al. (2004). "Evaluating collaborative filtering recommender systems"


